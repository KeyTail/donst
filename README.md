1)Использование внешних провайдеров
1.1) Биткоин нода + лайтнинг:
    Биткоин нода настроена, для лайтнинг используем сервис LND

1.2)Каналы:
    -https://amboss.space/magma создаем заявку, на нас открывают канал
    плюсы:
        сразу получаем inbound liquidity
    минусы:
        платим магме фиксированную комиссию за каждый канал или подписка
        когда у нашего канала закончится входящая ликвидность, возможны 2 варианта:
            -отправить куда то ликвидность через swap сервисы
            -закрыть канал, получить средства ончейн (если срок аренды еще не истек - в магме понижается рейтинг)

    -https://lightningnetwork.plus/pool, открываем канал на одних, другие открывают каналы на нас. Все в добровольной форме
    плюсы:
        бесплатно
    минусы:
        шанс, что на нас подпишется большой узел маловероятен

    -свой сервис:
    записаываем вручную список крупных и надёжных узлов, на которые можем открыть канал. Берем, например, 30 крупных и стабильных по времени работающих узлов и всегда поддерживать связь как минимум с 5 из них.
    Если вдруг один из узлов, решит закрыть канал, то мы автоматически подключимся к следующему.
    Закрывший узел отправим в черный список.
    Около 80 процентов исходящей ликвидности сразу отправлять в swap, чтобы могли принимать платежи.
    Остальные 20 - для участия в маршрутизации чужих платежей и получения комиссионного вознаграждения
    плюсы:
        автономность, практически не зависим ни от кого, кроме узлов, на кого будем открывать каналы (а крупные узлы обычно стабильны)
        будем в центре больших узлов:
            -нашему клиенту проще находить маршрут до нас, соответственно комиссия будет дешевле
            -есть шанс стать валидатором платежа и заработать

1.3)Работа с ликвидностью:
    https://boltz.exchange/ - атомарный обменник, где либо вся транзакция проходит, либо нет
    комиссия примерно 0.5% + комиссия ончейн
    Максимальная сумма свапа 0.25 BTC
    плюсы:
        простота использования через АПИ, не нужно держать свой сервис

    loopd - сервис от lightning labs позволяющий управлять ликвидностью.
    свапы не атомарны, есть шанс потерять prepay fee, если транзакция не прошла (высокие комиссии, нагруженый мемпул в биткоине)
    комиссия 0.05% - 0.5% + on-chain fee + prepay fee
    плюсы:
        глубокая интеграция с LND

1.4)Watchtower:
    Инструмент для защиты от мошшеничества со стороны контрагента. Используем от LND, стабильный и автономный


2)Структура проекта
2.1)Каналы:
    Предлагаю реализовать собственный сервис, который будет автоматически:
        -открывать каналы
        -выводить большую часть ликвидности, чтобы обеспечить возможность приема входящих платежей

    Список топовых узлов будем формировать вручную на основе данных с https://mempool.space/lightning/nodes/rankings/connectivity
    Следить за активными каналами и при снижении количества (к примеру менее 5) - автоматически подключаться к новым из нашего списка
    Узлы, которые отключили канал - будем заносить в черный список и исключать из повторных подключений в будущем

    Преимущества подхода:
        -подключение к топовым узлам делает нас более доступными в маршрутах для клиента и комисии ниже
        -возможность заработать на маршрутизации чужих платежей

    Автоматическая ребалансировка:
    если inbound liquidity падет ниже 30%:
        -перенаправляем средства партнерам (off-chain напрямую или on-chain через swap, если они указали в настройках)
        -либо выводить на свои адреса (on-chain) в оптимальное время (когда комиссии в on-chain или у swap низкие) и не ждать пока inbound liquidity станет нулевой

2.2)Инвойсы:
    Одноразовый временный платеж:
        -с фиксированной суммой
        -без фиксированной суммы

    Примечания:
        1 инвойс = транзакция, повторно использовать инвойс нельзя
        ограничены по времени, партнер сможет выставлять время 

    keysend-платеж:
    зная наш узел, пользователь может отправить нам средства. Однако мы ничего не будем о пользователе, что не подходит под нашу концепцию приема платежей

2.3)Выплаты:
    Автоматические выводы:
        В админке партнеры смогут указать, свои адреса off-chain/on-chain для вывода для того чтобы мы могли опустошать inbound liquidity
        В приоритете для нас будет off-chain выводы, т.к. комиссии будут ниже
        On-chain выводы будут происходить в моменты дешевых комиссий swap'a или дешевых комиссий сети биткоина. Если же inbound liquidity менее 10 процентов, то на комиссии не смотрим
        Если же некому выводить из партнеров, то выводим себе

    Выводы по запросу от партнера:
        off-chain будут производиться моментально
        on-chain по 2 сценариям:
            с аргументом quick - моментально, не смотря на комиссии
            без аргумента - ставится в очередь и будет ожидать пока комиссии swap/on-chain будут приемлемых значениях


2.4)Воркеры:
    проверка рабочих каналов, если мало, то автоматически поднимаем новые
    проверка liquidity, если слишком много inbound liquidity - автовывод
    прием платежей
    callback партнеров

2.6)Отдельный клиент LN (только для теста):
    открытие канала
    закрытие канала (с возможность указать не актуальное состояние)
    приема входящих платежей
    отправка платежей

    Хотя это будет использоваться на этапе разработке и начальной стадии запуска, но сохранить на будущее будет полезно


2.5)Админка:
    Django, быстрее настроить и легче поддерживать


3)Риски
3.1)Шанс того что один или большая часть внезапно могут закрыть канал:
    Мы планируем открывать каналы к крупным публичным узлам (по объему, аптайму). Такие узлы заинтересованы в стабильной работе и, как правило не инициириуют закрытие каналов без необходимости, особенно ликвидных каналов т.к. экономически выгодно: приносят доход за счет маршрутизации.

3.2)Бэкапы:
    LN использует off-chain канальные состояния, которые критичны для безопасности. При внезапной перезагрузке ноды, возможна ситуация, при которой нода запустится с устаревшим состояние канала:
        и стать уязвимой к атаке со стороны второго участника, при закрытии ноды. Указав старый транзакцию в свою "пользу"

3.3)Fraudulent channel close:
    Атака, при закрытии канала указывается устаревшее состояние канала в пользу "мошенника"
    Если у нас не будет более нового состояния, то средства будут распределены согласно старому (мошенническому) балансу, и мы потеряем часть или все деньги
    Если же у нас будет более новое состояние, мы можем предъявить и получить все средства канала в качестве наказания (penalty transaction). В автономном режиме за нас этим занимается watchtower, но для его корректной работы необходимо, чтобы он обладал актуальными данными по состояниям каналов
